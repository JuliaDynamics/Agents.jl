<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>CellListMap.jl · Agents.jl</title><meta name="title" content="CellListMap.jl · Agents.jl"/><meta property="og:title" content="CellListMap.jl · Agents.jl"/><meta property="twitter:title" content="CellListMap.jl · Agents.jl"/><meta name="description" content="Documentation for Agents.jl."/><meta property="og:description" content="Documentation for Agents.jl."/><meta property="twitter:description" content="Documentation for Agents.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Agents.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Agents.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../sir/">SIR model for the spread of COVID-19</a></li><li><a class="tocitem" href="../flock/">Flocking model</a></li><li><a class="tocitem" href="../zombies/">Zombie Outbreak in a City</a></li><li><a class="tocitem" href="../predator_prey/">Predator-prey dynamics</a></li><li><a class="tocitem" href="../rabbit_fox_hawk/">3D Mixed-Agent Ecosystem with Pathfinding</a></li><li><a class="tocitem" href="../event_rock_paper_scissors/">Spatial rock-paper-scissors (event based)</a></li><li><a class="tocitem" href="../">More Examples for Agents.jl</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li><li><a class="tocitem" href="../agents_visualizations/">Plotting and Interactivity</a></li><li><span class="tocitem">Ecosystem Integration</span><ul><li><a class="tocitem" href="../optim/">BlackBoxOptim.jl</a></li><li><a class="tocitem" href="../diffeq/">DifferentialEquations.jl</a></li><li><a class="tocitem" href="../schoolyard/">Graphs.jl</a></li><li><a class="tocitem" href="../measurements/">Measurements.jl</a></li><li class="is-active"><a class="tocitem" href>CellListMap.jl</a><ul class="internal"><li><a class="tocitem" href="#The-system-simulated"><span>The system simulated</span></a></li><li><a class="tocitem" href="#Required-and-data-structures-for-CellListMap.jl"><span>Required and data structures for CellListMap.jl</span></a></li><li><a class="tocitem" href="#Model-initialization"><span>Model initialization</span></a></li><li><a class="tocitem" href="#Computing-the-pairwise-particle-forces"><span>Computing the pairwise particle forces</span></a></li><li><a class="tocitem" href="#Update-agent-positions-and-velocities"><span>Update agent positions and velocities</span></a></li><li><a class="tocitem" href="#The-simulation"><span>The simulation</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../performance_tips/">Performance Tips</a></li><li><a class="tocitem" href="../../comparison/">ABM Framework Comparison</a></li><li><a class="tocitem" href="../../devdocs/">Developer Docs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Ecosystem Integration</a></li><li class="is-active"><a href>CellListMap.jl</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>CellListMap.jl</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaDynamics/Agents.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaDynamics/Agents.jl/blob/main/examples/celllistmap.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Integrating-Agents.jl-with-CellListMap.jl"><a class="docs-heading-anchor" href="#Integrating-Agents.jl-with-CellListMap.jl">Integrating Agents.jl with CellListMap.jl</a><a id="Integrating-Agents.jl-with-CellListMap.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Integrating-Agents.jl-with-CellListMap.jl" title="Permalink"></a></h1><video width="auto" controls autoplay loop>
<source src="../celllistmap.mp4" type="video/mp4">
</video><p>This example illustrates how to integrate Agents.jl with <a href="https:://github.com/m3g/CellListMap.jl">CellListMap.jl</a>, to accelerate the computation of short-ranged (within a cutoff) interactions in 2D and 3D continuous spaces. CellListMap.jl is a package that allows the computation of pairwise interactions using an efficient and parallel implementation of <a href="https://en.wikipedia.org/wiki/Cell_lists">cell lists</a>.</p><h2 id="The-system-simulated"><a class="docs-heading-anchor" href="#The-system-simulated">The system simulated</a><a id="The-system-simulated-1"></a><a class="docs-heading-anchor-permalink" href="#The-system-simulated" title="Permalink"></a></h2><p>The example will illustrate how to simulate a set of particles in 2 dimensions, interacting through a simple repulsive potential of the form:</p><p class="math-container">\[U(r) = k_i k_j\left[r^2 - (r_i+r_j)^2\right]^2~~~\textrm{for}~~~r \leq (r_i+r_j)\]</p><p class="math-container">\[U(r) = 0.0~~~\textrm{for}~~~r \gt (r_i+r_j)\]</p><p>where <span>$r_i$</span> and <span>$r_j$</span> are the radii of the two particles involved, and <span>$k_i$</span> and <span>$k_j$</span> are constants associated to each particle. The potential energy function is a smoothly decaying potential with a maximum when the particles overlap.</p><p>Thus, if the maximum sum of radii between particles is much smaller than the size of the system, cell lists can greatly accelerate the computation of the pairwise forces.</p><p>Each particle will have different radii and different repulsion force constants and masses.</p><pre><code class="language-julia hljs">using Agents</code></pre><p>Below we define the <code>Particle</code> type, which represents the agents of the simulation. The <code>Particle</code> type, for the <code>ContinuousAgent{2,Float64}</code> space, will have additionally an <code>id</code> and <code>pos</code> (position) and <code>vel</code> (velocity) fields, which are automatically added by the <code>@agent</code> macro.</p><pre><code class="language-julia hljs">@agent struct Particle(ContinuousAgent{2,Float64})
    r::Float64 # radius
    k::Float64 # repulsion force constant
    mass::Float64
end
PropParticle(; vel, r, k, mass) = (vel, r, k, mass)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PropParticle (generic function with 1 method)</code></pre><h2 id="Required-and-data-structures-for-CellListMap.jl"><a class="docs-heading-anchor" href="#Required-and-data-structures-for-CellListMap.jl">Required and data structures for CellListMap.jl</a><a id="Required-and-data-structures-for-CellListMap.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Required-and-data-structures-for-CellListMap.jl" title="Permalink"></a></h2><p>We will use the high-level interface provided by the <code>PeriodicSystems</code> module (requires version ≥0.7.22):</p><pre><code class="language-julia hljs">using CellListMap.PeriodicSystems</code></pre><p>Two auxiliary arrays will be created on model initialization, to be passed to the <code>PeriodicSystem</code> data structure:</p><ol><li><code>positions</code>: <code>CellListMap</code> requires a vector of (preferentially) static vectors as the positions of the particles. To avoid creating this array on every call, a buffer to which the <code>agent.pos</code> positions will be copied is stored in this data structure.</li><li><code>forces</code>: In this example, the property to be computed using <code>CellListMap.jl</code> is the forces between particles, which are stored here in a <code>Vector{&lt;:SVector}</code>, of the same type as the positions. These forces will be updated by the <code>map_pairwise!</code> function.</li></ol><p>Additionally, the computation with <code>CellListMap.jl</code> requires the definition of a <code>cutoff</code>, which will be twice the maximum interacting radii of the particles, and the geometry of the the system, given by the <code>unitcell</code> of the periodic box.</p><p>More complex output data, variable system geometries and other options are supported, according to the <a href="https://m3g.github.io/CellListMap.jl/stable/PeriodicSystems/">CellListMap.PeriodicSystems</a> user guide.</p><h2 id="Model-initialization"><a class="docs-heading-anchor" href="#Model-initialization">Model initialization</a><a id="Model-initialization-1"></a><a class="docs-heading-anchor-permalink" href="#Model-initialization" title="Permalink"></a></h2><p>We create the model with a keyword-accepting function as is recommended in Agents.jl. The keywords here control number of particles and sizes.</p><pre><code class="language-julia hljs">function initialize_bouncing(;
    number_of_particles=10_000,
    sides=SVector(500.0, 500.0),
    dt=0.001,
    max_radius=10.0,
    parallel=true
)
    # initial random positions
    positions = [sides .* rand(SVector{2,Float64}) for _ in 1:number_of_particles]

    # We will use CellListMap to compute forces, with similar structure as the positions
    forces = similar(positions)

    # Space and agents
    space2d = ContinuousSpace(sides; periodic=true)

    # Initialize CellListMap periodic system
    system = PeriodicSystem(
        positions=positions,
        unitcell=sides,
        cutoff=2 * max_radius,
        output=forces,
        output_name=:forces, # allows the system.forces alias for clarity
        parallel=parallel,
    )

    # define the model properties
    # The system field contains the data required for CellListMap.jl
    properties = (
        dt=dt,
        number_of_particles=number_of_particles,
        system=system,
    )
    model = StandardABM(Particle,
        space2d;
        agent_step!,
        model_step!,
        agents_first = false,
        properties=properties
    )

    # Create active agents
    for id in 1:number_of_particles
        pos = positions[id]
        prop_particle = PropParticle(
            r = (0.5 + 0.9 * rand()) * max_radius,
            k = 10 + 20 * rand(), # random force constants
            mass = 10.0 + 100 * rand(), # random masses
            vel = 100 * randn(SVector{2}) # initial velocities)
            )
        add_agent!(pos, Particle, model, prop_particle...)
    end

    return model
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">initialize_bouncing (generic function with 1 method)</code></pre><h2 id="Computing-the-pairwise-particle-forces"><a class="docs-heading-anchor" href="#Computing-the-pairwise-particle-forces">Computing the pairwise particle forces</a><a id="Computing-the-pairwise-particle-forces-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-pairwise-particle-forces" title="Permalink"></a></h2><p>To follow the <code>CellListMap</code> interface, we first need a function that computes the force between a single pair of particles. This function receives the positions of the two particles (already considering the periodic boundary conditions), <code>x</code> and <code>y</code>, their indices in the array of positions, <code>i</code> and <code>j</code>, the squared distance between them, <code>d2</code>, the <code>forces</code> array to be updated and the <code>model</code> properties.</p><p>Given these input parameters, the function obtains the properties of each particle from the model, and computes the force between the particles as (minus) the gradient of the potential energy function defined above.</p><p>The function <em>must</em> return the <code>forces</code> array, to follow the <code>CellListMap</code> API.</p><pre><code class="language-julia hljs">function calc_forces!(x, y, i, j, d2, forces, model)
    p_i = model[i]
    p_j = model[j]
    d = sqrt(d2)
    if d ≤ (p_i.r + p_j.r)
        dr = y - x # x and y are minimum-image relative coordinates
        fij = 2 * (p_i.k * p_j.k) * (d2 - (p_i.r + p_j.r)^2) * (dr / d)
        forces[i] += fij
        forces[j] -= fij
    end
    return forces
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">calc_forces! (generic function with 1 method)</code></pre><p>The <code>model_step!</code> function will use <code>CellListMap</code> to update the forces for all particles. The first argument of the call is the function to be computed for each pair of particles, which closes-over the <code>model</code> data to call the <code>calc_forces!</code> function defined above.</p><pre><code class="language-julia hljs">function model_step!(model::ABM)
    # Update the pairwise forces at this step
    map_pairwise!(
        (x, y, i, j, d2, forces) -&gt; calc_forces!(x, y, i, j, d2, forces, model),
        model.system,
    )
    return nothing
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">model_step! (generic function with 1 method)</code></pre><h2 id="Update-agent-positions-and-velocities"><a class="docs-heading-anchor" href="#Update-agent-positions-and-velocities">Update agent positions and velocities</a><a id="Update-agent-positions-and-velocities-1"></a><a class="docs-heading-anchor-permalink" href="#Update-agent-positions-and-velocities" title="Permalink"></a></h2><p>The <code>agent_step!</code> function will update the particle positions and velocities, given the forces, which are computed in the <code>model_step!</code> function. A simple Euler step is used here for simplicity. Finally, the positions within the <code>CellListMap.PeriodicSystem</code> structure are updated.</p><pre><code class="language-julia hljs">function agent_step!(agent, model::ABM)
    id = agent.id
    dt = abmproperties(model).dt
    # Retrieve the forces on agent id
    f = model.system.forces[id]
    a = f / agent.mass
    # Update positions and velocities
    v = agent.vel + a * dt
    x = agent.pos + v * dt + (a / 2) * dt^2
    x = normalize_position(x, model)
    agent.vel = v
    move_agent!(agent, x, model)
    # !!! IMPORTANT: Update positions in the CellListMap.PeriodicSystem
    model.system.positions[id] = agent.pos
    return nothing
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">agent_step! (generic function with 1 method)</code></pre><h2 id="The-simulation"><a class="docs-heading-anchor" href="#The-simulation">The simulation</a><a id="The-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#The-simulation" title="Permalink"></a></h2><p>Finally, the function below runs an example simulation, for 1000 steps.</p><pre><code class="language-julia hljs">function simulate(model=nothing; nsteps=1_000, number_of_particles=10_000)
    if isnothing(model)
        model = initialize_bouncing(number_of_particles=number_of_particles)
    end
    Agents.step!(model, nsteps)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">simulate (generic function with 2 methods)</code></pre><p>Which should be quite fast</p><pre><code class="language-julia hljs">model = initialize_bouncing()
@time simulate(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">StandardABM with 10000 agents of type Particle
 agents container: Dict
 space: periodic continuous space with [500.0, 500.0] extent and spacing=25.0
 scheduler: fastest
 properties: dt, number_of_particles, system</code></pre><p>and let&#39;s make a nice video with less particles, to see them bouncing around. The marker size is set by the radius of each particle, and the marker color by the corresponding repulsion constant.</p><pre><code class="language-julia hljs">using CairoMakie
model = initialize_bouncing(number_of_particles=1000)
abmvideo(
    &quot;celllistmap.mp4&quot;, model;
    framerate=20, frames=200, dt=5,
    title=&quot;Softly bouncing particles with CellListMap.jl&quot;,
    agent_size=p -&gt; p.r,
    agent_color=p -&gt; p.k
)</code></pre><video width="auto" controls autoplay loop>
<source src="../celllistmap.mp4" type="video/mp4">
</video></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../measurements/">« Measurements.jl</a><a class="docs-footer-nextpage" href="../../performance_tips/">Performance Tips »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 10 April 2024 17:47">Wednesday 10 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
